<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
    <meta content='width=device-width, initial-scale=1' name='viewport'>
    <link href='../../../assets/images/businesscore-64x64.png' rel='icon'>
    <title>CGC Docs | News Letter 2: C++</title>
    <link href="../../../assets/stylesheets/application.css" rel="stylesheet" />
  </head>
  <body class='cgc-release-documentation cgc-release-documentation_newsletter cgc-release-documentation_newsletter_cpp cgc-release-documentation_newsletter_cpp_index'>
    <div id='container'>
      <div id='nav_col'>
        <div id='logo'>
          <a href='/'>
            CGC Docs, published by Legitimate Business Syndicate
          </a>
        </div>
        <div id='nav'>
          <ul>
            <li>
              <a href='/'>Welcome</a>
            </li>
            <li class='hdr'>Event-FAQ</li>
            <li>
              <a href='/Event-FAQ/event_faq/'>Event FAQ</a>
            </li>
            <li class='hdr'>cb-testing</li>
            <li>
              <a href='/cb-testing/cb-acceptance/'>cb-acceptance</a>
            </li>
            <li>
              <a href='/cb-testing/cb-replay/'>cb-replay</a>
            </li>
            <li>
              <a href='/cb-testing/cb-replay-pov/'>cb-replay-pov</a>
            </li>
            <li>
              <a href='/cb-testing/cb-test/'>cb-test</a>
            </li>
            <li>
              <a href='/cb-testing/poll-validate/'>poll-validate</a>
            </li>
            <li class='hdr'>cgc-release-documentation/newsletter</li>
            <li>
              <a href='/cgc-release-documentation/newsletter/ipc/'>News Letter 1: IPC</a>
            </li>
            <li>
              <a href='/cgc-release-documentation/newsletter/cpp/'>News Letter 2: C++</a>
            </li>
            <li>
              <a href='/cgc-release-documentation/newsletter/ctf/'>News Letter 3: CTF</a>
            </li>
            <li>
              <a href='/cgc-release-documentation/newsletter/template/'>News Letter X: Template</a>
            </li>
            <li class='hdr'>cgc-release-documentation/walk-throughs</li>
            <li>
              <a href='/cgc-release-documentation/walk-throughs/building-a-cb/'>Building a Challenge Binary</a>
            </li>
            <li>
              <a href='/cgc-release-documentation/walk-throughs/cgc-repository/'>CGC Repositories</a>
            </li>
            <li>
              <a href='/cgc-release-documentation/walk-throughs/debugging-a-cb/'>Debugging a Challenge Binary</a>
            </li>
            <li>
              <a href='/cgc-release-documentation/walk-throughs/pin-for-decree/'>Running Intel PIN on DECREE Challenge Binaries</a>
            </li>
            <li>
              <a href='/cgc-release-documentation/walk-throughs/running-the-vm/'>Running the Virtual Machine</a>
            </li>
            <li>
              <a href='/cgc-release-documentation/walk-throughs/scoring-cbs/'>Scoring a Challenge Binary Set</a>
            </li>
            <li>
              <a href='/cgc-release-documentation/walk-throughs/submitting-a-cb/'>Submitting a Challenge Binary</a>
            </li>
            <li>
              <a href='/cgc-release-documentation/walk-throughs/testing-a-cb/'>Testing a Challenge Binary</a>
            </li>
            <li>
              <a href='/cgc-release-documentation/walk-throughs/understanding-poll-generators/'>Understanding Poll Generators</a>
            </li>
            <li>
              <a href='/cgc-release-documentation/walk-throughs/understanding-cfe-povs/'>Understanding Proofs of Vulnerability in CFE</a>
            </li>
            <li>
              <a href='/cgc-release-documentation/walk-throughs/using-the-network-appliance/'>Using the Network Appliance</a>
            </li>
            <li>
              <a href='/cgc-release-documentation/walk-throughs/virtual-competiton/'>Virtual Competition</a>
            </li>
            <li>
              <a href='/cgc-release-documentation/walk-throughs/ptrace-for-decree/'>Writing an Instruction Tracer for DECREE Challenge Binaries Using ptrace</a>
            </li>
            <li class='hdr'>cgc2elf</li>
            <li>
              <a href='/cgc2elf/cgc2elf/'>cgc2elf</a>
            </li>
            <li class='hdr'>cgcef-verify</li>
            <li>
              <a href='/cgcef-verify/cgcef_verify/'>cgcef_verify</a>
            </li>
            <li class='hdr'>libcgc</li>
            <li>
              <a href='/libcgc/allocate/'>allocate</a>
            </li>
            <li>
              <a href='/libcgc/cgcabi/'>CGC ABI</a>
            </li>
            <li>
              <a href='/libcgc/deallocate/'>deallocate</a>
            </li>
            <li>
              <a href='/libcgc/fdwait/'>fdwait</a>
            </li>
            <li>
              <a href='/libcgc/random/'>random</a>
            </li>
            <li>
              <a href='/libcgc/receive/'>receive</a>
            </li>
            <li>
              <a href='/libcgc/terminate/'>_terminate</a>
            </li>
            <li>
              <a href='/libcgc/transmit/'>transmit</a>
            </li>
            <li class='hdr'>libcgcef</li>
            <li>
              <a href='/libcgcef/cgc_executable_format/'>CGC Executable Format</a>
            </li>
            <li class='hdr'>libpov</li>
            <li>
              <a href='/libpov/libpov/'>libpov</a>
            </li>
            <li>
              <a href='/libpov/type1_negotiate/'>type1_negotiate</a>
            </li>
            <li>
              <a href='/libpov/type2_negotiate/'>type2_negotiate</a>
            </li>
            <li>
              <a href='/libpov/type2_submit/'>type2_submit</a>
            </li>
            <li class='hdr'>network-appliance</li>
            <li>
              <a href='/network-appliance/cb-packet-log/'>cb-packet-log</a>
            </li>
            <li>
              <a href='/network-appliance/cb-proxy/'>cb-proxy</a>
            </li>
            <li>
              <a href='/network-appliance/verify-rules/'>verify-rules</a>
            </li>
            <li class='hdr'>poll-generator</li>
            <li>
              <a href='/poll-generator/generate-polls/'>generate-polls</a>
            </li>
            <li class='hdr'>pov-xml2c</li>
            <li>
              <a href='/pov-xml2c/pov-xml2c/'>pov-xml2c</a>
            </li>
            <li class='hdr'>service-launcher</li>
            <li>
              <a href='/service-launcher/cb-server/'>cb-server</a>
            </li>
            <li class='hdr'>virtual-competition</li>
            <li>
              <a href='/virtual-competition/ti-client/'>ti-client</a>
            </li>
            <li>
              <a href='/virtual-competition/ti-rotate/'>ti-rotate</a>
            </li>
            <li>
              <a href='/virtual-competition/ti-server/'>ti-server</a>
            </li>
          </ul>
        </div>
      </div>
      <div id='main_col'>
        <div id='title'>
          <h1>News Letter 2: C++</h1>
        </div>
        <div id='content'>
          <h2 id="introduction">Introduction</h2>
          
          <p>The C++ Programming Language provides interesting opportunities to
          generate challenge binaries. Many C++ features such as function or
          operator overloading are completely lost in statically linked,
          stripped binaries, but the heavy use of pointers and function pointers
          demonstrate the challenges inherent in complex object oriented
          applications.</p>
          
          <h2 id="background">Background</h2>
          
          <p>The Cyber Grand Challenge FAQ <a href="https://cgc.darpa.mil/documents.aspx" title="Cyber Grand Challenge: Frequently Asked Questions (FAQ), July 24, 2014.">[1]</a>, Answer #12 states that the
          "The C family of languages" will be used to write CBs.  This newsletter
          addresses some of the caveats of producing challenge binaries with C++
          (specifically the supported clang++ compiler in the reference virtual
          machine).</p>
          
          <h2 id="implementation">Implementation</h2>
          
          <p>Several features of the C++ language can be made to work with minimal
          effort.  Features like abstract classes (vtables), function / operator
          overloads, auto variables, etc. work without effort; those features
          requiring special handling are detailed below.</p>
          
          <h3 id="new--delete"><code class="highlighter-rouge">new</code> / <code class="highlighter-rouge">delete</code></h3>
          
          <p>The <code class="highlighter-rouge">new</code> and <code class="highlighter-rouge">delete</code> operators can be implemented in terms of
          <code class="highlighter-rouge">malloc()</code>/<code class="highlighter-rouge">free()</code> if available in the CB's library (ultimately in
          terms of the <code class="highlighter-rouge">allocate()</code> and <code class="highlighter-rouge">deallocate()</code> DECREE system calls).</p>
          
          <div class="highlighter-rouge"><pre class="highlight"><code>void *operator new(unsigned int sz) {&#x000A;  return malloc(sz);&#x000A;}&#x000A;&#x000A;void *operator new[](unsigned int sz) {&#x000A;  return ::operator new(sz);&#x000A;}&#x000A;&#x000A;void operator delete(void *p) {&#x000A;  free(p);&#x000A;}&#x000A;&#x000A;void operator delete[](void *p) {&#x000A;  ::operator delete(p);&#x000A;}&#x000A;</code></pre>
          </div>
          
          <h3 id="static-constructors">Static constructors</h3>
          
          <p>The libcgc runtime does not automatically call static constructors: it
          simply calls <code class="highlighter-rouge">main()</code> followed by <code class="highlighter-rouge">_terminate()</code>. Static constructors are
          given entries in a hidden linker array bounded by the symbols
          <code class="highlighter-rouge">__init_array_start</code> and <code class="highlighter-rouge">__init_array_end</code>.  The functions are simply
          called in order of appearance in the array, like so:</p>
          
          <div class="highlighter-rouge"><pre class="highlight"><code>#define __hidden __attribute__((__visibility__("hidden")))&#x000A;&#x000A;void *__dso_handle; /* required symbol, but not used */&#x000A;&#x000A;extern "C" {&#x000A;  extern void (*__init_array_start[])(int, char **, char **) __hidden;&#x000A;  extern void (*__init_array_end[])(int, char **, char **) __hidden;&#x000A;};&#x000A;&#x000A;void call_inits(void) {&#x000A;  size_t asize;&#x000A;  void (*fn)(int, char **, char **);&#x000A;&#x000A;  asize = __init_array_end - __init_array_start;&#x000A;  for (size_t n = 0; n &lt; asize; n++) {&#x000A;    fn = __init_array_start[n];&#x000A;    if (fn &amp;&amp; (long)fn != 1)&#x000A;      fn(0, (char **)NULL, (char **)NULL);&#x000A;  }&#x000A;}&#x000A;&#x000A;int main() {&#x000A;  call_inits();&#x000A;  ...&#x000A;}&#x000A;</code></pre>
          </div>
          
          <h3 id="static-destructors">Static destructors</h3>
          
          <p>The compiler generates calls to a function called <code class="highlighter-rouge">__cxa_atexit()</code> for
          static destructors.  CB authors must provide an implementation of that
          function (it is indirectly called from a <code class="highlighter-rouge">__init_array</code> function, so
          support for static constructors must be in place first). A possible
          implementation of <code class="highlighter-rouge">__cxa_atexit</code> is show below.</p>
          
          <div class="highlighter-rouge"><pre class="highlight"><code>extern "C" {&#x000A;  int __cxa_atexit(void (*func)(void *), void *arg, void *dso);&#x000A;};&#x000A;&#x000A;static struct exit_handlers {&#x000A;  void (*func)(void *);&#x000A;  void *arg;&#x000A;} exit_handlers[100];&#x000A;static int nhandlers = 0;&#x000A;&#x000A;int __cxa_atexit(void (*func)(void *), void *arg, void *dso) {&#x000A;  if (nhandlers == sizeof(exit_handlers)/sizeof(exit_handlers[0]))&#x000A;    return (-1);&#x000A;  exit_handlers[nhandlers].func = func;&#x000A;  exit_handlers[nhandlers].arg = arg;&#x000A;  nhandlers++;&#x000A;  return (0);&#x000A;}&#x000A;&#x000A;int main() {&#x000A;&#x000A;  ...&#x000A;&#x000A;  for (int i = 0; i &lt; nhandlers; i++)&#x000A;    exit_handlers[i].func(exit_handlers[i].arg);&#x000A;  return (0);&#x000A;}&#x000A;</code></pre>
          </div>
          
          <h3 id="miscellaneous">Miscellaneous</h3>
          
          <p>CB Authors may, under some circumstances, need to provide
          implementations of the following functions:</p>
          
          <div class="highlighter-rouge"><pre class="highlight"><code>void std::terminate(void);&#x000A;extern "C" {&#x000A;  void *memset(void *, int, size_t);&#x000A;  void __cxa_pure_virtual();&#x000A;};&#x000A;</code></pre>
          </div>
          
          <h2 id="caveats">Caveats</h2>
          
          <p>Several language features are notably missing.  The Standard Template
          Library (STL) is not provided for challenge binaries. This includes
          most of the C++ runtime (iostreams, maps, vectors, etc.). CB authors
          are not allowed to reuse existing code but are allowed to write their own
          libraries for reuse (see <a href="https://github.com/CyberGrandChallenge/cgc-release-documentation/blob/master/walk-throughs/submitting-a-cb.md" title="Submitting a Challenge Binary">[3]</a> for further guidance).</p>
          
          <p>C++ exceptions are currently not implemented and doing so appears to be
          non-trivial exercise. Some of the necessary functionality is present
          in libcgc in the form of <code class="highlighter-rouge">setjmp</code>/<code class="highlighter-rouge">longjmp</code>.  CB authors requiring
          exceptions will have to provide an implementations of:</p>
          
          <div class="highlighter-rouge"><pre class="highlight"><code>__cxa_call_unexpected();&#x000A;void *__cxa_begin_catch(void *);&#x000A;_Unwind_Resume();&#x000A;/* possibly more [[2]][ref2] */&#x000A;</code></pre>
          </div>
          
          <p>Run Time Type Information (RTTI) is also not supported. This
          effectively disables <code class="highlighter-rouge">dynamic_cast&lt;&gt;</code> and <code class="highlighter-rouge">typeid</code>. Support for this
          language feature requires the implementation of various objects
          conforming to the CLANG C++ ABI version 1, e.g.:</p>
          
          <div class="highlighter-rouge"><pre class="highlight"><code>__cxxabiv1::__class_type_info&#x000A;__cxxabiv1::__si_class_type_info&#x000A;etc.&#x000A;</code></pre>
          </div>
          
          <p>An example implementation can be found in the CLANG C++ Runtime library.</p>
          
          <h2 id="example">Example</h2>
          
          <p>An example challenge binary using C++ can be found in <a href="file:/usr/share/cgc-sample-challenges/examples/TNETS_00002" title="TNETS_00002 in reference virtual machine">[4]</a>. It uses all
          of the features described above to implement a virtual pet
          service. The cgc-cb.mk Makefile assumes that C++ files are named with
          a ".cc" extension and will call the compiler appropriately.</p>
          
          <h2 id="conclusion">Conclusion</h2>
          
          <p>The examples provided here demonstrate the use of C++ as a challenge
          binary source language with the starting for a CB author to implement some of
          the richer C++ features.</p>
          
          <h2 id="references">References</h2>
          
          <p>[1] <a href="https://cgc.darpa.mil/documents.aspx" title="Cyber Grand Challenge: Frequently Asked Questions (FAQ), July 24, 2014.">Cyber Grant Challenge: Frequently Asked Questions(FAQ)</a></p>
          
          <p>[2] <a href="http://libcxxabi.llvm.org/spec.html" title="libc++ ABI Specification">libc++ ABI Specification</a></p>
          
          <p>[3] <a href="https://github.com/CyberGrandChallenge/cgc-release-documentation/blob/master/walk-throughs/submitting-a-cb.md" title="Submitting a Challenge Binary">Submitting a Challenge Binary</a></p>
          
          <p>[4] <a href="file:/usr/share/cgc-sample-challenges/examples/TNETS_00002" title="TNETS_00002 in reference virtual machine">TNETS_00002 in reference virtual machine</a></p>
        </div>
      </div>
    </div>
    <footer>
      <div id='impressum'>Published by Legitimate Business Syndicate</div>
      <div id='timestamp'>Built at 2016-05-20T22:02:47Z</div>
      <div>
        <ul>
          <li><a href="https://legitbs.net">Homepage</a></li>
          <li><a href="https://twitter.com/legitbs_ctf">Twitter</a></li>
          <li><a href="https://github.com/legitbs">GitHub</a></li>
          <li><a href="https://github.com/legitbs/cgc-docs">This repo</a></li>
        </ul>
      </div>
    </footer>
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="../../../assets/javascripts/application.js"></script>
    <script>
      !function(l,e,g,i,t,b,s){l.GoogleAnalyticsObject=g;l[g]||(l[g]=function(){
      (l[g].q=l[g].q||[]).push(arguments)});l[g].l=+new Date;b=e.createElement(i);
      s=e.getElementsByTagName(i)[0];b.src=t;s.parentNode.insertBefore(b,s)}
      (window,document,'ga','script','//www.google-analytics.com/analytics.js');
      
      ga('create', 'UA-38870141-4', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>
